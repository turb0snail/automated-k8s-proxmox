#cloud-config
hostname: k8s-worker
manage_etc_hosts: true

users:
  - name: kubeadmin
    gecos: Kubernetes Admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    groups: users, admin
    lock_passwd: false
    passwd: $2y$10$tOfmX8pgFqefZ0p6DBLjMe6UJwg/.LYOMUwY.xIrIIJNPth59LQIu
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMqnrgJss9sO/z8xPbomObHhOV7Uare2kOfjWUMghIB9 proxmox-kube

ssh_pwauth: true
disable_root: false

chpasswd:
  list: |
    kubeadmin:Kube@1234
  expire: false

package_update: true
package_upgrade: true

network:
  version: 2
  ethernets:
    ens18:
      dhcp4: true

write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter

  - path: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

runcmd:
  - modprobe overlay
  - modprobe br_netfilter
  - sysctl --system
  - apt-get update && apt-get install -y apt-transport-https ca-certificates curl
  - curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
  - echo "deb https://apt.kubernetes.io/ kubernetes-xenial main" > /etc/apt/sources.list.d/kubernetes.list
  - apt-get update
  - apt-get install -y containerd kubelet kubeadm
  - systemctl enable containerd

